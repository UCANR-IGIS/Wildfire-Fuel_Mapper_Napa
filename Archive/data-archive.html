<!DOCTYPE html>
<html>
    <head>
        <!-- Site made with Mobirise Website Builder v3.12.1, https://mobirise.com -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="generator" content="Mobirise v3.12.1, mobirise.com">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="assets/images/logo.png" type="image/x-icon">
        <meta name="description" content="">

        <title>California Land Trends</title>




        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:700,400&amp;subset=cyrillic,latin,greek,vietnamese">
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-sortable.css">
        <link rel="stylesheet" href="assets/animate.css/animate.min.css">
        <link rel="stylesheet" href="assets/mobirise/css/style.css">
        <link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">
        <link rel="stylesheet" href="https://js.arcgis.com/4.3/esri/css/main.css">

        <style>

            html,
            body,
            #sidebar {
                height: 100%;
                overflow-y: scroll;
            }
            .esri-legend{
                display: none;
            }
            ul {
                list-style-type: none;
                padding: 0;
            }
            li.key {
                float: left;
                border-top-width: 15px;
                border-top-style: solid;
                width: 10%;
                padding-left: 0;
                padding-right: 0;
                list-style:none;
            }
            path {
                stroke-width: 1px;
                stroke: gray;
                fill: #999;
                cursor: pointer;
            }
            path.q0-5 {
                fill: #ffffd4;
            }
            path.q1-5 {
                fill: #fed98e;
            }
            path.q2-5 {
                fill: #fe9929;
            }
            path.q3-5 {
                fill: #d95f0e;
            }
            path.q4-5 {
                fill: #993404;
            }
            h1, h2 {
                letter-spacing: 2px;   
            }
        </style>


    </head>


    <body>
       <section class="mbr-navbar mbr-navbar--freeze mbr-navbar--absolute mbr-navbar--sticky mbr-navbar--auto-collapse" id="ext_menu-0">
            <div class="mbr-navbar__section mbr-section">
                <div class="mbr-section__container container">
                    <div class="mbr-navbar__container">
                        <div class="mbr-navbar__column mbr-navbar__column--s mbr-navbar__brand">
                            <span class="mbr-navbar__brand-link mbr-brand mbr-brand--inline">
                                <span class="mbr-brand__logo"><img src="assets/images/logo.png" class="mbr-navbar__brand-img mbr-brand__img" alt="Mobirise"></span>
                                <span class="mbr-brand__name"><a class="mbr-brand__name text-white">CALIFORNIA LAND TRENDS</a></span>
                            </span>
                        </div>
                        <div class="mbr-navbar__hamburger mbr-hamburger"><span class="mbr-hamburger__line"></span></div>
                        <div class="mbr-navbar__column mbr-navbar__menu">
                            <nav class="mbr-navbar__menu-box mbr-navbar__menu-box--inline-right">
                                <div class="mbr-navbar__column">
                                    <ul class="mbr-navbar__items mbr-navbar__items--right float-left mbr-buttons mbr-buttons--freeze mbr-buttons--right btn-decorator mbr-buttons--active"><li class="mbr-navbar__item"><a class="mbr-buttons__link btn text-white" href="home.html">HOME</a></li><li class="mbr-navbar__item"><a class="mbr-buttons__link btn text-white" href="data.html">DATA</a></li><li class="mbr-navbar__item"><a class="mbr-buttons__link btn text-white" href="about.html">ABOUT</a></li><li class="mbr-navbar__item"><a class="mbr-buttons__link btn text-white" href="contact.html">CONTACT</a></li></ul>                            
                                </div>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <section id="data" class="mbr-section mbr-section--relative mbr-section--fixed-size" id="features1-3" style="background-color: rgb(255, 255, 255);">


            <div class="mbr-section__container container mbr-section__container--std-top-padding" style="padding-top: 93px;">
                <div class="mbr-section__row row">

                    <div class="row" id="row-main">
                        <!-- sidebar -->
                        <div class="col-md-4" id="sidebar">
                            <h4>Sidebar</h4>
                            <div id="test1">
                                <div class="btn-group pull-left">
                                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                                        Select Data <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a class="m" value="totCrop" href="#">Cropland Acres</a></li>
                                        <li><a class="m" value="numOwn" href="#">Number of Owners</a></li>
                                        <li><a class="m" value="pctCrop" href="#">Percent Cropland</a></li>
                                        <li><a class="m" value="pctOwn" href="#">Percent Cropland Largest Owner Controls</a></li>
                                        <li><a class="m" value="avgAcre" href="#">Mean Cropland Acres</a></li>
                                        <li><a class="m" value="Gini" href="#">Gini Coefficient</a></li>
                                    </ul>
                                </div>
                                <div id="mapCell"></div>
                                <div id=legend></div>
                            </div>
                            <div id="test2">
                                <h2 id="CountyName"></h2>
                                <table id="dataTable2" class="table table-bordered table-striped">
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            <div id="cropGraphs">
                                <div>
                                    <h4>Crops as Percentage of Total Cropland</h4>
                                    <div class="box-wrap">
                                        <div class="box-inner">
                                            <div class="row-fluid">
                                                <div class="widget-main">
                                                    <div id="piechart-placeholder-pct"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4>Percent of Total Acreage and Number of Owners by Acreage Class</h4>
                                    <div class="box-wrap">
                                        <div class="box-inner">
                                            <div id="Bar-Chart"></div>
                                            <div id="bar-legend" align="center"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4>Cumulative Sum of Acres by Landowner</h4>
                                    <div class="box-wrap">
                                        <div class="box-inner">
                                            <div id="cum-acres-charts"></div>
                                            <div id="acre-legend" align="center"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div id="content" class="col-md-8" style="padding: 0px">
                            <div id="toggleSidebar">
                                <button type="button" class="btn btn-default toggle-sidebar">Toggle Sidebar</button>
                                <button type="button" class="btn btn-default toggle-layers">Toggle Layers</button>
                                <button type="button" class="btn btn-default toggle-legend">Toggle Legend</button>
                            </div>
                            <div id="viewDiv"></div>

                        </div>

                    </div>
                </div>
            </div>
        </section>

        <section class="mbr-section mbr-section--relative mbr-section--fixed-size" id="contacts1-5" style="background-color: rgb(70, 70, 70);">

            <div class="mbr-section__container container">
                <div class="mbr-contacts mbr-contacts--wysiwyg row" style="padding-top: 0px; padding-bottom: 30px;">
                    <div style="text-align:center">
                        <a  style="color: white" href="http://ucanr.edu/">Agriculture and Natural Resources, University of California</a><br/>

                        <a style="font-size: 70%; color: white" href="http://ucanr.edu/Copyright/">©2016 Regents of the University of California</a>

                        <a style="font-size: 70%; color: white" href="http://ucanr.edu/sites/anrstaff/Diversity/Affirmative_Action/Resources/Policy-related_downloads/">Nondiscrimination Statement</a>

                        <a style="font-size: 70%; color: white" href="http://ucanr.edu/Accessibility/">Accessibility</a>

                        <a style="font-size: 70%; color: white" href="#">Privacy Policy</a>

                        <a style="font-size: 70%; color: white" href="#">Help</a>

                    </div>
                </div>
            </div>
        </section>


        <script src="assets/web/assets/jquery/jquery.min.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/smooth-scroll/smooth-scroll.js"></script>
        <script src="assets/jarallax/jarallax.js"></script>
        <script src="js/d3-format.min.js"></script>
        <!--[if lte IE 9]>
<script src="assets/jquery-placeholder/jquery.placeholder.min.js"></script>
<![endif]-->
        <script src="http://d3js.org/d3.v3.js"></script>
        <script src="http://d3js.org/topojson.v2.min.js"></script>
        <script src="js/colorbrewer.js"></script>
        <script src="js/bootstrap-sortable.js"></script>
        <script src="js/moment.min.js"></script>
        <script src="js/flot/jquery.flot.min.js"></script>
        <script src="js/flot/jquery.flot.pie.min.js"></script>
        <script src="js/flot/jquery.flot.orderBars.js"></script>
        <script src="js/flot/jquery.flot.resize.min.js"></script>
        <script src="assets/mobirise/js/script.js"></script>
        <script src="assets/formoid/formoid.min.js"></script>
        <script src="https://js.arcgis.com/4.3/"></script>
        <script>
            var countyLayer;
            require([
                "esri/Map",
                "esri/geometry/Extent",
                "esri/tasks/QueryTask",
                "esri/tasks/support/Query",
                "esri/Graphic",
                "esri/layers/GraphicsLayer",
                "esri/symbols/SimpleFillSymbol",
                "esri/symbols/SimpleLineSymbol",
                "dojo/_base/Color",
                "esri/views/MapView",
                "esri/layers/MapImageLayer",
                "esri/widgets/LayerList",
                "esri/widgets/Legend",
                "esri/layers/FeatureLayer",
                "esri/tasks/IdentifyTask",
                "esri/tasks/support/IdentifyParameters",
                "dojo/_base/array",
                "dojo/on",
                "dojo/dom",
                "dojo/parser",
                "dojo/domReady!"
            ], function(Map, Extent, QueryTask, Query, Graphic, GraphicsLayer, SimpleFillSymbol, SimpleLineSymbol, Color, MapView, MapImageLayer, LayerList, Legend, FeatureLayer, IdentifyTask, IdentifyParameters, arrayUtils, on, dom, parser) {

                countyLayer = new GraphicsLayer();

                divHeight();

                parser.parse();

                var countyNames,
                    Counties = "https://geodata.ucanr.edu/arcgis/rest/services/Geoenrichment/MapServer/2",
                    Parcels = new MapImageLayer("https://geodata.ucanr.edu/arcgis/rest/services/CalLandTrends/CA_Parcels/MapServer", {
                        "opacity": 0.45
                    }),
                    parcelURL ="https://geodata.ucanr.edu/arcgis/rest/services/CalLandTrends/CA_Parcels/MapServer",
                    qAdminBoundaries = new Query(),
                    countyLayerGap = new GraphicsLayer();

                var map = new Map({
                    basemap: "topo"
                });

                var view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center:[-119.44944, 37.16611],
                    zoom:6
                });

                view.then(function() {
                    var layerList = new LayerList({
                        view: view,
                    });

                    // Add widget to the top right corner of the view
                    view.ui.add(layerList, "top-right");

                    var legend = new Legend({
                        view: view
                    });

                    // Add widget to the bottom right corner of the view
                    view.ui.add(legend, "top-right");

                    // executeIdentifyTask() is called each time the view is clicked
                    on(view, "click", executeIdentifyTask);

                    // Create identify task for the specified map service
                    identifyTask = new IdentifyTask(parcelURL);

                    // Set the parameters for the Identify
                    params = new IdentifyParameters();
                    params.tolerance = 3;
                    params.layerIds = [0, 1, 2];
                    params.layerOption = "all";
                    params.width = view.width;
                    params.height = view.height;
                });


                map.add(Parcels);

                var selectedCounty = "Mendocino";
                var adminLevel = "County";

                querySelectedAdmin(scrubItem(selectedCounty));

                function scrubItem(myList) {
                    myList = myList.replace(/,/g, "','");
                    myList = myList.replace(/%2C%20/g, "','");
                    myList = myList.replace(/%20/g, " ");
                    whereclause = myList;
                    return myList;
                }

                function getCookie(cname) {
                    var name = cname + "=";
                    var ca = document.cookie.split(';');
                    for (var i = 0; i < ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) == ' ') {
                            c = c.substring(1);
                        }
                        if (c.indexOf(name) != -1) {
                            return c.substring(name.length, c.length);
                        }
                    }
                    return "";
                }


                function showResults(featureSet) {
                    clearGraphics();
                    //Performance enhancer - assign featureSet array to a single variable.
                    var resultFeatures = featureSet.features,
                        symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 0, 0]), 1), new Color([232, 169, 169, 0.2]));
                    //Loop through each feature returned
                    for (var i = 0, il = resultFeatures.length; i < il; i++) {
                        //Get the current feature from the featureSet.
                        //Feature is a graphic
                        var graphic = new Graphic({
                            geometry: resultFeatures[i].geometry,
                            symbol: symbol
                        });
                        //Add graphic to the map graphics layer.
                        countyLayer.add(graphic);
                    }
                    map.add(countyLayer);

                    view.goTo({target: countyLayer.graphics});
                }

                function clearGraphics() {
                    //first remove all graphics added directly to map
                    view.graphics.removeAll();
                    countyLayer.removeAll();

                }

                function querySelectedAdmin(Area) {
                    if (adminLevel === "County") {
                        qtAdminBoundaries = new QueryTask(Counties);
                        qAdminBoundaries.where = "NAME in ('" + Area + "')";
                    } else if (adminLevel === "State") {
                        qtAdminBoundaries = new QueryTask(States);
                        qAdminBoundaries.where = "NAME in ('" + Area + "')"
                    } else {
                        qtAdminBoundaries = new QueryTask(Countries);
                        qAdminBoundaries.where = "NAME in ('" + Area + "')";
                    }
                    qAdminBoundaries.geometry = "";
                    qAdminBoundaries.returnGeometry = true;
                    qtAdminBoundaries.execute(qAdminBoundaries).then(function(results) {
                        showResults(results);
                    });
                    //qtAdminBoundaries.;pexecute(qAdminBoundaries, showResultsGap);
                }

                function selectedGraphic(event) {
                    if (adminLevel === "County") {
                        countyNames = event.graphic.attributes.name;
                    } else if (adminLevel === "State") {
                        countyNames = event.graphic.attributes.NAME;
                    } else {
                        countyNames = event.graphic.attributes.name;
                    }
                }

                // Executes each time the view is clicked
                function executeIdentifyTask(event) {

                    var popupTemplate;

                    // Set the geometry to the location of the view click
                    params.geometry = event.mapPoint;
                    params.mapExtent = view.extent;
                    dom.byId("viewDiv").style.cursor = "wait";

                    // This function returns a promise that resolves to an array of features
                    // A custom popupTemplate is set for each feature based on the layer it
                    // originates from
                    identifyTask.execute(params).then(function(response) {

                        var county,
                            landtype,
                            acres,
                            cdl,
                            gap;

                        var results = response.results;

                        for (var i = 0, il = results.length; i < il; i++)  {

                            var result = results[i];

                            if (result.layerId === 0) {
                                county = result.feature.attributes.county;
                                landtype = result.feature.attributes.landtype;
                                acres = result.feature.attributes.acres;
                            }
                            else if (result.layerId === 1) {
                                cdl = result.feature.attributes.class_name;
                            }
                            else if (result.layerId === 2) {
                                gap = result.feature.attributes.nvc_subcl;
                            }


                        }

                        popupTemplate = { // autocasts as new PopupTemplate()
                            title: county + " County",
                            content: "<b>Ownership:</b> " + landtype +
                            "<br><b>Acres:</b> " + acres +
                            "<br><b>CDL:</b> " + cdl +
                            "<br><b>GAP:</b> " + gap
                        }

                    }).then(showPopup); // Send the array of features to showPopup()

                    // Shows the results of the Identify in a popup once the promise is resolved
                    function showPopup(response) {
                        //if (response.length > 0) {
                        view.popup.open({
                            title: popupTemplate.title,
                            content: popupTemplate.content,
                            location: event.mapPoint
                        });
                        //}
                        dom.byId("viewDiv").style.cursor = "auto";
                    }
                }

                //Map dimensions (in pixels)
                //Map dimensions (in pixels)
                var margin = {top: 10, left: 10, bottom: 10, right: 10}
                , width = parseInt(d3.select('#mapCell').style('width'))
                , width = width - margin.left - margin.right
                , mapRatio = 1.5
                , height = width * mapRatio;

                var projection = d3.geo.conicEqualArea()
                .scale(1994.978558619655)
                .center([-119.47209322983564,37.183576208477184])
                //projection center
                .parallels([32.5341607414223,42.009523270089595])
                //parallels for conic projection
                .rotate([119.47209322983564])
                .translate([-2358.9122406793554,-1638.2278171194982]); //translate to center the map in vi

                var path = d3.geo.path()
                .projection(projection);

                //Create an SVG
                var svg = d3.select("#mapCell").append("svg")
                .attr("width", width)
                .attr("height", height);

                //Group for the map features
                var features = svg.append("g")
                .attr("class","features");

                //Create choropleth scale
                var cscale;
                var domain = [];

                updateChoro("totCrop");

                var totCrop;

                //Set number formatting
                var ft = d3.format(",.2f");
                var f = d3.format(".2f");
                var t = d3.format(",");
                var p = d3.format(".2%");
                var tp = d3.format(".0");

                var countyID;

                $('#cropGraphs').hide();

                d3.select("#CountyName").select("text").remove();
                d3.select("#CountyName").append("text")
                .text("Please click a county on the state-level map to begin");




                function updateChoro(choro) {

                    d3.json("http://services.arcgis.com/0xnwbwUttaTjns4i/ArcGIS/rest/services/CalLandTrendsGap/FeatureServer/0/query?where=1%3D1&outFields=*&returnGeometry=true&returnCentroid=false&returnIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnDistinctValues=false&returnZ=false&returnM=false&sqlFormat=none&f=pgeojson",function(error,geodata) {
                        if (error) return console.log(error); //unknown error, check the console

                        var title;


                        if (choro == "totCrop") {
                            totCrop = "Sum_";
                            cscale = colorbrewer.RdYlGn[5]
                            domain = [500000, 1000000, 2000000, 3000000]
                            title = "Cropland Acres"
                            document.getElementById("legend").innerHTML="<span class = legendTitle>" + title + "</span>";
                        }
                        if (choro == "numOwn") {
                            totCrop = "Count_";
                            cscale = colorbrewer.RdYlGn[5]
                            domain = [5000, 15000, 30000, 70000]
                            title = "Number of Landowners"
                            document.getElementById("legend").innerHTML="<span class = legendTitle>" + title + "</span>";
                        }
                        if (choro == "pctCrop") {
                            totCrop = "PerCropCou";
                            cscale = colorbrewer.RdYlGn[5]
                            domain = [0.006, 0.016, 0.064, 0.3]
                            title = "Percent Cropland"
                            document.getElementById("legend").innerHTML="<span class = legendTitle>" + title + "</span>";
                        }
                        if (choro == "pctOwn") {
                            totCrop = "PerOwnerCr";
                            cscale = colorbrewer.RdYlGn[5]
                            domain = [0.05, 0.1, 0.2, 0.4]
                            title = "Percent Cropland Largest Owner Controls"
                            document.getElementById("legend").innerHTML="<span class = legendTitle>" + title + "</span>";
                        }
                        if (choro == "avgAcre") {
                            totCrop = "Mean";
                            cscale = colorbrewer.RdYlGn[5]
                            domain = [15, 30, 50, 100]
                            title = "Mean Cropland Acres"
                            document.getElementById("legend").innerHTML="<span class = legendTitle>" + title + "</span>";
                        }
                        if (choro == "Gini") {
                            totCrop = "Gini";
                            cscale = colorbrewer.RdYlGn[5]
                            domain = [0.48, 0.61, 0.69, 0.76]
                            title = "Gini Coefficient"
                            document.getElementById("legend").innerHTML="<span class = legendTitle>" + title + "</span>";
                        }

                        var color = d3.scale.threshold()
                        .domain(domain)
                        .range(cscale);

                        d3.select("#mapCell svg g")
                        .selectAll("path")
                        .remove();

                        //Create a path for each map feature in the data
                        features.selectAll("path")
                        .data(geodata.features)
                        .enter()
                        .append("path")
                        .attr("d",path)
                        .style("fill", function(d) { return color(d.properties[totCrop]); })
                        .on("click",clicked);


                        d3.select('#legend')
                        .selectAll('ul')
                        .remove();

                        // build the map legend
                        var legend = d3.select('#legend')
                        .append('ul')
                        .attr('class', 'list-inline');

                        var keys = legend.selectAll('li.key')
                        .data(color.range());

                        var legend_items = ["Low", "", "", "", "High"];

                        keys.enter().append('li')
                        .attr('class', 'key')
                        .style('border-top-color', String)
                        .text(function (d, i) {
                            return legend_items[i];
                        });

                    });

                };

                function cdlCumAcres(objectID) {

                    var AlfalfaHay = [];
                    var Almonds = [];
                    var Corn = [];
                    var Cotton = [];
                    var Fallow = [];
                    var FruitTrees = [];
                    var GrainCrops = [];
                    var Grapes = [];
                    var OtherTreeCrops = [];
                    var Rice = [];
                    var Tomatoes = [];
                    var VegsFruits = [];
                    var Walnuts = [];
                    var WinterWheat = [];

                    $.getJSON( "http://services.arcgis.com/0xnwbwUttaTjns4i/ArcGIS/rest/services/CalLandTrendsGap/FeatureServer/0/queryRelatedRecords?objectIds="+objectID+"&relationshipId=1&outFields=*&definitionExpression=&orderByFields=PropertySize&returnCountOnly=false&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&resultOffset=&resultRecordCount=&f=pjson&token=", function( datajson ) {

                        $.each( datajson.relatedRecordGroups[0].relatedRecords, function( key, val) {

                            switch(val.attributes.Crop) {
                                case "Alfalfa & Hay":
                                    AlfalfaHay.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Almonds":
                                    Almonds.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Corn":
                                    Corn.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Cotton":
                                    Cotton.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Fallow":
                                    Fallow.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Fruit Trees":
                                    FruitTrees.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Grain Crops":
                                    GrainCrops.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Grapes":
                                    Grapes.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Other Tree Crops":
                                    OtherTreeCrops.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Rice":
                                    Rice.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Tomatoes":
                                    Tomatoes.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Vegs & Fruits":
                                    VegsFruits.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Walnuts":
                                    Walnuts.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                                case "Winter Wheat":
                                    WinterWheat.push([val.attributes.PropertySize, val.attributes.CumulativeAcres]);
                                    break;
                            }
                        });

                        var data = [];

                        if (AlfalfaHay.length> 0) {
                            data.push({data: AlfalfaHay, label: "Alfalfa", color: "#DEBB27"})
                        }
                        if (Almonds.length> 0) {
                            data.push({data: Almonds, label: "Almonds", color: "#84784f"})
                        }
                        if (Corn.length> 0) {
                            data.push({data: Corn, label: "Corn", color: "#f9f900"})
                        }
                        if (Cotton.length> 0) {
                            data.push({data: Cotton, label: "Cotton", color: "#dbdbdb"})
                        }
                        if (Fallow.length> 0) {
                            data.push({data: Fallow, label: "Fallow", color: "#562c0a"})
                        }
                        if (FruitTrees.length> 0) {
                            data.push({data: FruitTrees, label: "Fruit Trees", color: "#f97020"})
                        }
                        if (GrainCrops.length> 0) {
                            data.push({data: GrainCrops, label: "Grain", color: "#8eeaff"})
                        }
                        if (Grapes.length> 0) {
                            data.push({data: Grapes, label: "Grapes", color: "#7f00ff" /*points: {radius:2.5, line: 0, fillColor: "#7f00ff"}*/})
                        }
                        if (OtherTreeCrops.length> 0) {
                            data.push({data: OtherTreeCrops, label: "Other Trees", color: "#48CA3B"})
                        }
                        if (Rice.length> 0) {
                            data.push({data: Rice, label: "Rice", color: "#0083ff"})
                        }
                        if (Tomatoes.length> 0) {
                            data.push({data: Tomatoes, label: "Tomatoes", color: "#ff0000"})
                        }
                        if (VegsFruits.length> 0) {
                            data.push({data: VegsFruits, label: "Vegs Fruits", color: "#016d06"})
                        }
                        if (Walnuts.length> 0) {
                            data.push({data: Walnuts, label: "Walnuts", color: "#f59bff"})
                        }
                        if (WinterWheat.length> 0) {
                            data.push({data: WinterWheat, label: "Winter Wheat", color: "#05006d"})
                        }

                        var cum_acres_charts = $('#cum-acres-charts').css({'width':'100%' , 'height':'350px'});
                        $.plot(cum_acres_charts, data, {
                            hoverable: true,
                            shadowSize: 0,
                            series: {
                                lines: { show: true },
                                points: { show: true, radius:2.5 }
                            },
                            legend: {
                                show: true,
                                noColumns: 7,
                                container: "#acre-legend"
                            },
                            xaxis: {
                                //tickLength: 0
                            },
                            yaxis: {
                                //ticks: 10,
                                //min: -2,
                                //max: 2,
                                //tickDecimals: 3
                            },
                            grid: {
                                backgroundColor: { colors: [ "#fff", "#fff" ] },
                                borderWidth: 1,
                                borderColor:'#555',
                                hoverable: true
                            },
                            tooltip: true, //activate tooltip
                            tooltipOpts: {
                                content: "%s : %y.1",
                                shifts: {
                                    x: -30,
                                    y: -50
                                }
                            }
                        });



                        var $tooltip = $("<div class='tooltip top in' style='display:none;'><div class='tooltip-inner'></div></div>").appendTo('body');
                        cum_acres_charts.data('tooltip', $tooltip);
                        var previousPoint = null;

                        cum_acres_charts.on('plothover', function (event, pos, item) {
                            if(item) {
                                if (previousPoint != item.seriesIndex) {
                                    previousPoint = item.seriesIndex;
                                    var tip = item.series['label'] + " Property Size: " + item.datapoint[0] + " Cumulative Acres: " + item.datapoint[1];
                                    $(this).data('tooltip').show().children(0).text(tip);
                                }
                                $(this).data('tooltip').css({top:pos.pageY + 10, left:pos.pageX + 10});
                            } else {
                                $(this).data('tooltip').hide();
                                previousPoint = null;
                            }
                        });
                    });

                };

                function cdlOwnerClass(objectID) {

                    var arrC1 = [];
                    var arrC2 = [];

                    var ticks = [];

                    $.getJSON( "http://services.arcgis.com/0xnwbwUttaTjns4i/ArcGIS/rest/services/CalLandTrendsGap/FeatureServer/0/queryRelatedRecords?objectIds="+objectID+"&relationshipId=4&outFields=*&definitionExpression=&orderByFields=&returnCountOnly=false&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&resultOffset=&resultRecordCount=&f=pjson&token=", function( datajson ) {

                        $.each( datajson.relatedRecordGroups[0].relatedRecords, function( key, val) {
                            arrC1.push( [key, tp(Math.round(val.attributes.PercentAcres*100))] );
                        });

                        $.each( datajson.relatedRecordGroups[0].relatedRecords, function( key, val2) {
                            arrC2.push( [key,tp(Math.round(val2.attributes.PercentOwners*100))] );
                        });

                        $.each( datajson.relatedRecordGroups[0].relatedRecords, function( key, val3) {
                            ticks.push( [key, val3.attributes.groupingcrop] );
                        });



                        var data = [];

                        data.push({label: "Acreage",data: arrC1,bars:{order:1},color: 'red'});

                        data.push({label: "Owners",data: arrC2,bars:{order:2},color: 'blue'});

                        var bWidth= 0.4;

                        var placeholder = $('#Bar-Chart').css({'width':'100%' , 'height':'300px'});

                        var p = $.plot(placeholder, data, {
                            series: {
                                bars: {
                                    show:true,
                                    lineWidth: 0.25,
                                    barWidth: bWidth
                                    //order: 1
                                }
                            },
                            grid: {
                                align: "center"
                            },
                            legend: {
                                show: true,
                                noColumns: 2,
                                container: "#bar-legend"
                            },
                            yaxis:{
                                axisLabel: '%',
                                tickSize: 10,
                                tickFormatter: function (val, axis) {return val + "%";},
                                autoscaleMargin: 0.2
                            },
                            xaxis:{
                                ticks: ticks,
                                //autoscaleMargin: 0.8
                            }
                        });

                        $.each(p.getData()[0].data, function(i, el){
                            var o = p.pointOffset({x: el[0], y: el[1]});
                            $('<div class="data-point-label" style="font-size:80%">' + tp(el[1]) + '%</div>').css( {
                                position: 'absolute',
                                left: o.left - 17,
                                top: o.top - 15,
                                display: 'none'
                            }).appendTo(p.getPlaceholder()).fadeIn('fast');
                        });

                        $.each(p.getData()[1].data, function(i, el){
                            var o = p.pointOffset({x: el[0], y: el[1]});
                            $('<div class="data-point-label" style="font-size:80%">' + tp(el[1]) + '%</div>').css( {
                                position: 'absolute',
                                left: o.left + 4,
                                top: o.top - 15,
                                display: 'none'
                            }).appendTo(p.getPlaceholder()).fadeIn('fast');
                        });
                    });

                };

                function cdlPieChart(objectID) {

                    var data1 = [];

                    $.getJSON( "http://services.arcgis.com/0xnwbwUttaTjns4i/ArcGIS/rest/services/CalLandTrendsGap/FeatureServer/0/queryRelatedRecords?objectIds="+objectID+"&relationshipId=0&outFields=*&definitionExpression=&orderByFields=&returnCountOnly=false&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&resultOffset=&resultRecordCount=&f=pjson&token=", function( datajson ) {

                        var trHTML = '';

                        $.each(datajson.relatedRecordGroups[0].relatedRecords, function(i, val) {

                            trHTML+='<tr><td>'+val.attributes.Broad+'</td><td>'+f(val.attributes.Sum_)+'</td><td>'+p(val.attributes.PerCropCounty)+'</td><td>'+val.attributes.Count_+'</td><td>'+f(val.attributes.Mean)+'</td><td>'+f(val.attributes.Gini)+'</td></tr>';
                        });

                        $('#dataTable tbody tr').remove();
                        $('#dataTable tbody').append(trHTML);
                        $.bootstrapSortable(true, undefined, 'default');

                        $.each( datajson.relatedRecordGroups[0].relatedRecords, function( key, val ) {
                            val.attributes.label = val.attributes.Broad;
                            val.attributes.data = val.attributes.PerCropCounty;
                            var color = "#48CA3B";
                            switch (val.attributes.Broad) {
                                case "Grain Crops":
                                    color = "#8eeaff";
                                    break;
                                case "Almonds":
                                    color = "#84784f";
                                    break;
                                case "Corn":
                                    color = "#f9f900";
                                    break;
                                case "Cotton":
                                    color = "#dbdbdb";
                                    break;
                                case "Fruit Trees":
                                    color = "#f97020";
                                    break;
                                case "Grapes":
                                    color = "#7f00ff";
                                    break;
                                case "Rice":
                                    color = "#0083ff";
                                    break;
                                case "Tomatoes":
                                    color = "#ff0000";
                                    break;
                                case "Vegs & Fruits":
                                    color = "#016d06";
                                    break;
                                case "Walnuts":
                                    color = "#f59bff";
                                    break;
                                case "Winter Wheat":
                                    color = "#05006d";
                                    break;
                                case "Fallow":
                                    color = "#562c0a";
                                    break;
                                case "Deciduous Forest":
                                    color = "#199301";
                                    break;
                                case "Evergreen Forest":
                                    color = "#0e5100";
                                    break;
                                case "Grassland":
                                    color = "#94a843";
                                    break;
                                case "High Intensity Developed":
                                    color = "#700101";
                                    break;
                                case "Low Intensity Developed":
                                    color = "#fc8f8f";
                                    break;
                                case "Mixed Forest":
                                    color = "#287a30";
                                    break;
                                case "Shrubland":
                                    color = "#686b3e";
                                    break;
                                case "Water":
                                    color = "#0a00ce";
                                    break;
                                case "Wetlands":
                                    color = "#3b3872";
                                    break;
                                case "Alfalfa & Hay":
                                    color = "#DEBB27";
                                    break;
                                case "Barren":
                                    color = "#474747";
                                    break;
                            }
                            val.attributes.color = color;

                            data1.push( val.attributes );
                        });

                        $.plot(placeholder, data1, {

                            series: {
                                pie: {
                                    show: true,
                                    tilt:1,
                                    highlight: {
                                        opacity: 0.25
                                    },
                                    stroke: {
                                        color: '#fff',
                                        width: 2
                                    },
                                    startAngle: 2

                                }
                            },
                            legend: {
                                show: true,
                                position: "ne",
                                labelBoxBorderColor: null,
                                margin:[0,0]
                            }
                            ,
                            grid: {
                                hoverable: true,
                                clickable: true
                            },
                            tooltip: true, //activate tooltip
                            tooltipOpts: {
                                content: "%s : %y.1",
                                shifts: {
                                    x: -30,
                                    y: -50
                                }
                            }

                        });

                    });

                    var placeholder = $('#piechart-placeholder-pct').css({'width':'100%' , 'min-height':'250px'});

                    var $tooltip = $("<div class='tooltip top in' style='display:none;'><div class='tooltip-inner'></div></div>").appendTo('body');
                    placeholder.data('tooltip', $tooltip);
                    var previousPoint = null;

                    placeholder.on('plothover', function (event, pos, item) {
                        if(item) {
                            if (previousPoint != item.seriesIndex) {
                                previousPoint = item.seriesIndex;
                                var tip = item.series['label'] + " : " + f(item.series['percent'])+'%';
                                $(this).data('tooltip').show().children(0).text(tip);
                            }
                            $(this).data('tooltip').css({top:pos.pageY + 10, left:pos.pageX + 10});
                        } else {
                            $(this).data('tooltip').hide();
                            previousPoint = null;
                        }

                    });
                };

                function clicked(d,i) {

                    $('#cropGraphs').show();
                    //$('#gapGraphs').show();

                    countyID = d.properties.OBJECTID;

                    querySelectedAdmin(d.properties.County);

                    var trHTML = '<tr><td>Total Acres</td><td>'+ft(d.properties.Sum_)+'</td></tr><tr><td>Owner Count</td><td>'+t(d.properties.Count_)+'</td></tr><tr><td>Percent Cropland</td><td>'+p(d.properties.PerCropCou)+'</td></tr><tr><td>Mean Acres</td><td>'+ft(d.properties.Mean)+'</td></tr><tr><td>Gini Coefficient</td><td>'+f(d.properties.Gini)+'</td></tr><tr><td>Percent Largest Owner</td><td>'+p(d.properties.PerOwnerCr)+'</td></tr>';

                    $('#dataTable2 tbody tr').remove();
                    $('#dataTable2 tbody').append(trHTML);

                    /*var trHTML2 = '<tr><td>Total Acres</td><td>'+ft(d.properties.SumGap)+'</td></tr><tr><td>Owner Count</td><td>'+t(d.properties.CountGap)+'</td></tr><tr><td>Percent Cropland</td><td>'+p(d.properties.PerGapCounty)+'</td></tr><tr><td>Mean Acres</td><td>'+ft(d.properties.MeanGap)+'</td></tr><tr><td>Gini Coefficient</td><td>'+f(d.properties.GiniGap)+'</td></tr><tr><td>Percent Largest Owner</td><td>'+p(d.properties.PerOwnerGapCounty)+'</td></tr>';

                    $('#dataTable3 tbody tr').remove();
                    $('#dataTable3 tbody').append(trHTML2);*/

                            d3.select("#CountyName").select("text").remove();
                            d3.select("#CountyName").append("text")
                            .text(d.properties.County + " County at a glance");
                            /*d3.select("#CountyNameGap").select("text").remove();
                    d3.select("#CountyNameGap").append("text")
                    .text(d.properties.County + " County at a glance");*/


                            cdlPieChart(d.properties.OBJECTID);
                            cdlOwnerClass(d.properties.OBJECTID);
                            cdlCumAcres(d.properties.OBJECTID);
                        };

                        function divHeight() {
                            $("#viewDiv").height($(window).height() - $("#ext_menu-0").height() - $("#contacts1-5").height());
                            $("#sidebar").height($(window).height() - $("#ext_menu-0").height() - $("#contacts1-5").height() + 40);
                        };

                        $(window).resize(divHeight);

                        // handle on click event to switch between maps
                        d3.selectAll(".m")
                        .on("click", function() {
                            var choro = this.getAttribute("value");
                            updateChoro(choro);
                        });

                        $(".toggle-layers").click(function () {
                            $(".esri-layer-list").toggle();

                        });

                        $(".toggle-legend").click(function () {
                            $(".esri-legend").toggle();

                        });

                        $(".toggle-sidebar").click(function () {
                            $("#sidebar").toggleClass("collapsed");
                            $("#content").toggleClass("col-md-12 col-md-8");

                            return false;
                        });
                    });
                </script>

            </body>
        </html>